<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Peta Purwokerto Utara</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <link rel="stylesheet" href="../../styles.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        display: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        primary: '#10b981',
                        'primary-dark': '#059669',
                        dark: '#0f172a',
                        'dark-light': '#1e293b',
                        accent: '#f59e0b',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }

        /* Custom Scrollbar for Sidebar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #1e3a8a;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #1e3a8a;
        }

        /* Custom Radio Button */
        .custom-radio:checked+div {
            border-color: #1e3a8a;
        }

        .custom-radio:checked+div .radio-dot {
            transform: scale(1);
        }

        /* Hide default OL controls */
        .ol-control {
            display: none !important;
        }

        .ol-attribution {
            display: none !important;
        }

        /* Modern Popup Styling */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 0;
            min-width: 300px;
            max-width: 340px;
            bottom: 20px;
            left: -50px;
            transform: translate(-50%, -100%);
            z-index: 100;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        .ol-popup.visible {
            opacity: 1;
            transform: translate(-50%, -105%);
            pointer-events: auto;
        }

        /* Remove default arrow */
        .ol-popup:after,
        .ol-popup:before {
            display: none;
        }

        .popup-header-modern {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 16px 20px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .popup-content-modern {
            padding: 20px;
            max-height: 320px;
            overflow-y: auto;
            background: white;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .info-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 8px;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 0.95rem;
            color: #0f172a;
            font-weight: 500;
            line-height: 1.4;
        }
    </style>
</head>

<body class="bg-slate-50 h-screen w-screen relative overflow-hidden">

    <!-- Map Container -->
    <div id="map" class="absolute inset-0 z-0"></div>

    <!-- Header -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 scrolled">
        <div class="container mx-auto px-4 lg:px-8">
            <nav class="flex items-center justify-between h-20">
                <a href="../../index.html" class="flex items-center gap-3 group">
                    <div
                        class="w-12 h-12 rounded-xl bg-white/10 backdrop-blur-sm flex items-center justify-center overflow-hidden border-2 border-white/20 group-hover:border-primary transition-all duration-300">
                        <img src="../../img/kab-banyumas.png" alt="Logo" class="w-10 h-10 object-contain">
                    </div>
                    <div class="text-white">
                        <h1 class="font-bold text-lg leading-tight">Kabupaten</h1>
                        <p class="font-semibold text-sm opacity-90">Banyumas</p>
                    </div>
                </a>

                <div class="hidden lg:flex items-center gap-1">
                    <a href="../../index.html" class="nav-link"><span class="nav-link-text">Beranda</span><span
                            class="nav-link-hover"></span></a>
                    <a href="pwtutara.html" class="nav-link active"><span class="nav-link-text">Peta
                            Kecamatan</span><span class="nav-link-hover"></span></a>
                    <!-- Dropdown Peta Desa -->
                    <div class="relative group">
                        <button class="nav-link flex items-center gap-1">
                            <span class="nav-link-text">Peta Desa</span>
                            <svg class="w-4 h-4 transition-transform duration-200 group-hover:rotate-180" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7">
                                </path>
                            </svg>
                            <span class="nav-link-hover"></span>
                        </button>
                        <div
                            class="absolute top-full left-0 w-56 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                            <div class="bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden">
                                <a href="../Desa/Desa Sumampir/Sumampir.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors border-b border-slate-50">Desa
                                    Sumampir</a>
                                <a href="../Desa/Desa Pabuaran/Pabuaran.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors border-b border-slate-50">Desa
                                    Pabuaran</a>
                                <a href="../Desa/Desa Grendeng/Grendeng.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors border-b border-slate-50">Desa
                                    Grendeng</a>
                                <a href="../Desa/Desa BancarKembar/BancarKembar.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors">Desa
                                    BancarKembar</a>
                            </div>
                        </div>
                    </div>
                    <a href="../../statistik.html" class="nav-link"><span class="nav-link-text">Data
                            Penduduk</span><span class="nav-link-hover"></span></a>
                    <a href="../../tentang.html" class="nav-link"><span class="nav-link-text">Tentang Saya</span><span
                            class="nav-link-hover"></span></a>
                </div>

                <button id="menuBtn"
                    class="lg:hidden relative w-12 h-12 flex items-center justify-center rounded-xl bg-white/10 backdrop-blur-sm border border-white/20">
                    <div class="hamburger"><span></span><span></span><span></span></div>
                </button>
            </nav>
        </div>

        <div id="mobileMenu" class="mobile-menu lg:hidden">
            <div class="container mx-auto px-4 py-6 space-y-2">
                <a href="../../index.html" class="mobile-link"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>Beranda</a>
                <a href="pwtutara.html" class="mobile-link active"><svg class="w-5 h-5" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>Peta Kecamatan</a>
                <div class="relative">
                    <button onclick="document.getElementById('mobile-submenu-desa').classList.toggle('hidden')"
                        class="w-full mobile-link flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            </svg>
                            Peta Desa
                        </div>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <div id="mobile-submenu-desa" class="hidden pl-12 pr-4 space-y-2 pb-2">
                        <a href="../Desa/Desa Sumampir/Sumampir.html"
                            class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            Sumampir</a>
                        <a href="../Desa/Desa Pabuaran/Pabuaran.html"
                            class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            Pabuaran</a>
                        <a href="../Desa/Desa Grendeng/Grendeng.html"
                            class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            Grendeng</a>
                        <a href="../Desa/Desa BancarKembar/BancarKembar.html"
                            class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            BancarKembar</a>
                    </div>
                </div>
                <a href="../../statistik.html" class="mobile-link"><svg class="w-5 h-5" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>Data Penduduk</a>
                <a href="../../tentang.html" class="mobile-link"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>Tentang Saya</a>
            </div>
        </div>
    </header>

    <!-- Floating Title Label -->
    <div class="absolute top-24 left-1/2 transform -translate-x-1/2 z-30 pointer-events-none">
        <div
            class="bg-white/80 backdrop-blur-md border border-white/50 shadow-xl shadow-blue-900/5 rounded-2xl px-6 py-2 flex items-center gap-3">
            <div class="relative flex h-3 w-3">
                <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-600"></span>
            </div>
            <h2 class="text-slate-800 font-bold text-xs tracking-widest uppercase">
                Peta Kecamatan Purwokerto Utara
            </h2>
        </div>
    </div>

    <!-- Sidebar (Floating Panel) -->
    <div id="sidebar"
        class="absolute top-24 left-6 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl shadow-slate-900/20 z-40 flex flex-col max-h-[calc(100vh-140px)] transition-all duration-500 transform translate-x-0 border border-white/50">
        <!-- Sidebar Header -->
        <div class="p-5 border-b border-gray-100 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-3 text-[#0f172a]">
                <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                    <i class="fas fa-layer-group"></i>
                </div>
                <span class="font-bold text-lg">Data & Layer</span>
            </div>
            <button id="close-sidebar"
                class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Village Filter -->
        <div class="px-5 pt-4 pb-0 shrink-0 bg-gray-50/50">
            <label for="village-select" class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                <i class="fas fa-filter text-blue-400 mr-1"></i> Filter Desa
            </label>
            <div class="relative">
                <select id="village-select"
                    class="w-full pl-3 pr-8 py-2.5 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm appearance-none text-gray-700 cursor-pointer">
                    <option value="">Semua Desa</option>
                    <option value="Sumampir">Sumampir</option>
                    <option value="Purwanegara">Purwanegara</option>
                    <option value="Pabuaran">Pabuaran</option>
                    <option value="Grendeng">Grendeng</option>
                    <option value="Karangwangkal">Karangwangkal</option>
                    <option value="Bobosan">Bobosan</option>
                    <option value="Bancarkembar">Bancarkembar</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                    <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="px-5 py-4 shrink-0 bg-gray-50/50">
            <div class="relative group">
                <i
                    class="fas fa-search absolute left-3.5 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-blue-600 transition-colors"></i>
                <input type="text" id="sidebar-search" placeholder="Cari Sekolah, balaidesa, kuburan .."
                    class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm">
            </div>
            <div id="sidebar-search-results"
                class="hidden mt-2 bg-white border border-gray-100 rounded-xl shadow-xl max-h-60 overflow-y-auto custom-scrollbar absolute w-[calc(100%-40px)] left-5 z-50">
            </div>
        </div>

        <!-- Layer Groups (Scrollable) -->
        <div class="p-5 overflow-y-auto custom-scrollbar flex-1 space-y-8">

            <!-- Base Maps -->
            <div class="bg-white rounded-xl">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fas fa-map text-blue-400"></i> Peta Dasar
                </h3>
                <div class="space-y-3" id="basemap-list">
                    <!-- Radio buttons injected here -->
                </div>
            </div>

            <!-- Map Layers -->
            <div class="bg-white rounded-xl">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fas fa-clone text-blue-400"></i> Layer Peta
                </h3>
                <div class="space-y-1" id="layer-list">
                    <!-- Toggles injected here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Toggle Sidebar Button -->
    <button id="open-sidebar"
        class="absolute top-24 left-6 w-12 h-12 bg-[#0f172a] text-white rounded-xl shadow-xl shadow-blue-900/20 z-30 flex items-center justify-center hover:bg-blue-900 hover:scale-105 transition-all hidden group">
        <i class="fas fa-layer-group text-lg group-hover:rotate-180 transition-transform duration-500"></i>
    </button>

    <!-- Top Right Controls -->
    <div class="absolute top-24 right-6 flex flex-col gap-3 z-30">
        <div class="bg-white/90 backdrop-blur rounded-xl shadow-lg shadow-slate-200/50 p-1.5 flex flex-col gap-1">
            <button id="btn-zoom-in"
                class="w-9 h-9 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all"
                title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <div class="h-px w-full bg-gray-100"></div>
            <button id="btn-zoom-out"
                class="w-9 h-9 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all"
                title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
        </div>

        <button id="btn-home"
            class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-lg shadow-slate-200/50 text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all"
            title="Home">
            <i class="fas fa-home text-lg"></i>
        </button>

        <button id="btn-location"
            class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-lg shadow-slate-200/50 text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all"
            title="Lokasi Saya">
            <i class="fas fa-crosshairs text-lg"></i>
        </button>
    </div>

    <!-- Bottom Right Info -->
    <div class="absolute bottom-8 right-6 flex flex-col items-end gap-4 z-30 pointer-events-none">
        <!-- Compass -->
        <div class="w-14 h-14 bg-white/90 backdrop-blur rounded-full shadow-xl shadow-slate-200/50 flex items-center justify-center pointer-events-auto transform transition-transform duration-500 cursor-pointer hover:scale-105 border-2 border-white"
            id="compass" title="Reset Utara">
            <i class="far fa-compass text-4xl text-blue-600"></i>
        </div>

        <!-- Coordinates -->
        <div
            class="bg-[#0f172a]/80 backdrop-blur-md px-4 py-2 rounded-full shadow-lg text-xs font-mono text-white pointer-events-auto border border-white/10 flex items-center gap-2">
            <i class="fas fa-map-marker-alt text-blue-400"></i>
            <span id="mouse-coordinates">Lat: -, Lng: -</span>
        </div>
    </div>

    <!-- Modern Popup -->
    <div id="popup" class="ol-popup">
        <div class="popup-header-modern">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-info text-white text-sm"></i>
                </div>
                <span id="popup-title" class="font-bold text-lg tracking-wide">Detail Info</span>
            </div>
            <a href="#" id="popup-closer" class="text-white/70 hover:text-white transition-colors">
                <i class="fas fa-times text-lg"></i>
            </a>
        </div>
        <div id="popup-content" class="popup-content-modern custom-scrollbar">
            <!-- Content injected via JS -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="resources/qgis2web_expressions.js"></script>
    <script src="./resources/functions.js"></script>
    <script src="./resources/ol.js"></script>
    <script src="resources/horsey.min.js"></script>
    <script src="resources/ol-search-layer.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="resources/photon-geocoder-autocomplete.min.js"></script>

    <!-- Load Layers -->
    <script src="layers/purwokertoutara_3.js"></script>
    <script src="layers/BatasWilayahDesa_4.js"></script>
    <script src="layers/purwanegara_5.js"></script>
    <script src="layers/Desa_6.js"></script>
    <script src="layers/PointKantorKec_7.js"></script>
    <script src="layers/Kuburan_8.js"></script>
    <script src="layers/BalaiDesa_9.js"></script>
    <script src="layers/sekolah_10.js"></script>

    <!-- Load Styles -->
    <script src="styles/purwokertoutara_3_style.js"></script>
    <script src="styles/BatasWilayahDesa_4_style.js"></script>
    <script src="styles/purwanegara_5_style.js"></script>
    <script src="styles/Desa_6_style.js"></script>
    <script src="styles/PointKantorKec_7_style.js"></script>
    <script src="styles/Kuburan_8_style.js"></script>
    <script src="styles/BalaiDesa_9_style.js"></script>
    <script src="styles/sekolah_10_style.js"></script>

    <script src="./layers/layers.js" type="text/javascript"></script>
    <script src="./resources/Autolinker.min.js"></script>
    <script src="./resources/qgis2web.js"></script>
    <script src="../../script.js"></script>

    <!-- Custom UI Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- 1. Sidebar Logic ---
            const sidebar = document.getElementById('sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const openSidebarBtn = document.getElementById('open-sidebar');

            function toggleSidebar(show) {
                if (show) {
                    sidebar.classList.remove('-translate-x-full', 'opacity-0');
                    sidebar.classList.add('translate-x-0', 'opacity-100');
                    openSidebarBtn.classList.add('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full', 'opacity-0');
                    sidebar.classList.remove('translate-x-0', 'opacity-100');
                    setTimeout(() => openSidebarBtn.classList.remove('hidden'), 500);
                }
            }

            closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
            openSidebarBtn.addEventListener('click', () => toggleSidebar(true));

            // --- 2. Layer Management ---
            const basemapList = document.getElementById('basemap-list');
            const layerList = document.getElementById('layer-list');

            function createBasemapRadio(layer, index, isChecked) {
                const id = `basemap-${index}`;
                const div = document.createElement('div');
                div.className = 'relative flex items-center cursor-pointer group p-2 rounded-lg hover:bg-gray-50 transition-colors';
                div.innerHTML = `
                    <input type="radio" name="basemap" id="${id}" class="peer sr-only" ${isChecked ? 'checked' : ''}>
                    <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center peer-checked:border-blue-600 transition-colors">
                        <div class="w-2.5 h-2.5 bg-blue-600 rounded-full transform scale-0 peer-checked:scale-100 transition-transform radio-dot"></div>
                    </div>
                    <label for="${id}" class="text-sm text-gray-600 group-hover:text-blue-800 cursor-pointer select-none font-medium">${layer.get('title')}</label>
                `;
                div.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') document.getElementById(id).click();
                });
                div.querySelector('input').addEventListener('change', () => {
                    layersList.forEach(l => { if (l.get('type') === 'base') l.setVisible(false); });
                    layer.setVisible(true);
                });
                return div;
            }

            function createLayerToggle(layer, index) {
                const id = `layer-${index}`;
                const title = layer.get('title') ? layer.get('title').replace(/<img.*?>/g, '').trim() : 'Unnamed Layer';
                const isVisible = layer.getVisible();

                const div = document.createElement('div');
                div.className = 'flex items-center justify-between py-2 px-2 rounded-lg hover:bg-gray-50 transition-colors';
                div.innerHTML = `
                    <span class="text-sm text-gray-700 font-medium">${title}</span>
                    <div class="relative inline-block w-11 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="${id}" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-0.5 ${isVisible ? 'right-0.5 border-blue-600' : 'left-0.5 border-gray-300'}" ${isVisible ? 'checked' : ''}/>
                        <label for="${id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-200 cursor-pointer transition-colors duration-300 ${isVisible ? 'bg-blue-600' : ''}"></label>
                    </div>
                `;

                const checkbox = div.querySelector('input');
                const label = div.querySelector('label');

                checkbox.addEventListener('change', function () {
                    layer.setVisible(this.checked);
                    if (this.checked) {
                        this.classList.add('right-0.5', 'border-blue-600');
                        this.classList.remove('left-0.5', 'border-gray-300');
                        label.classList.add('bg-blue-600');
                        label.classList.remove('bg-gray-200');
                    } else {
                        this.classList.add('left-0.5', 'border-gray-300');
                        this.classList.remove('right-0.5', 'border-blue-600');
                        label.classList.add('bg-gray-200');
                        label.classList.remove('bg-blue-600');
                    }
                });
                return div;
            }

            if (typeof layersList !== 'undefined') {
                layersList.forEach((layer, index) => {
                    if (layer.get('type') === 'base') {
                        const isChecked = layer.getVisible();
                        basemapList.appendChild(createBasemapRadio(layer, index, isChecked));
                    } else if (layer instanceof ol.layer.Group) {
                        const groupTitle = layer.get('title');
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'mb-4';
                        groupDiv.innerHTML = `<h4 class="text-xs font-bold text-blue-600 uppercase mb-2 ml-2 tracking-wider">${groupTitle}</h4>`;
                        layer.getLayers().forEach((subLayer, subIndex) => {
                            groupDiv.appendChild(createLayerToggle(subLayer, `${index}-${subIndex}`));
                        });
                        layerList.appendChild(groupDiv);
                    } else {
                        layerList.appendChild(createLayerToggle(layer, index));
                    }
                });
            }

            // --- 3. Map Controls ---
            const btnZoomIn = document.getElementById('btn-zoom-in');
            const btnZoomOut = document.getElementById('btn-zoom-out');
            const btnHome = document.getElementById('btn-home');
            const btnLocation = document.getElementById('btn-location');
            const compass = document.getElementById('compass');
            const coordDisplay = document.getElementById('mouse-coordinates');

            // Koordinat Awal Kecamatan Purwokerto Utara
            const centerPwtUtara = [12160858.2126635, -826645.3741325];
            const initialZoom = 12.5; // Scale approx 1:100.000

            if (typeof map !== 'undefined') {
                // Atur tampilan awal saat web dibuka
                map.getView().setCenter(centerPwtUtara);
                map.getView().setZoom(initialZoom);

                // Add Label "Kecamatan Purwokerto Utara"
                const labelFeature = new ol.Feature({
                    geometry: new ol.geom.Point(centerPwtUtara),
                    name: 'Kecamatan Purwokerto Utara'
                });
                const labelStyle = new ol.style.Style({
                    text: new ol.style.Text({
                        text: 'Kecamatan Purwokerto Utara',
                        font: 'bold 16px "Plus Jakarta Sans", sans-serif',
                        fill: new ol.style.Fill({ color: '#1e3a8a' }),
                        stroke: new ol.style.Stroke({ color: '#ffffff', width: 3 }),
                        offsetY: 0
                    })
                });
                labelFeature.setStyle(labelStyle);
                const labelLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [labelFeature]
                    }),
                    zIndex: 999,
                    title: 'Label Kecamatan'
                });
                map.addLayer(labelLayer);

                btnZoomIn.addEventListener('click', () => {
                    const view = map.getView();
                    view.animate({ zoom: view.getZoom() + 1, duration: 250 });
                });

                btnZoomOut.addEventListener('click', () => {
                    const view = map.getView();
                    view.animate({ zoom: view.getZoom() - 1, duration: 250 });
                });


                btnLocation.addEventListener('click', () => {
                    if (typeof geolocation !== 'undefined') {
                        if (!geolocation.getTracking()) geolocation.setTracking(true);
                        const pos = geolocation.getPosition();
                        if (pos) {
                            map.getView().animate({ center: pos, zoom: 17, duration: 1000 });
                        } else {
                            alert("Lokasi belum ditemukan. Pastikan GPS aktif.");
                        }
                    }
                });

                map.on('pointermove', function (evt) {
                    const coords = ol.proj.toLonLat(evt.coordinate);
                    coordDisplay.innerText = `Lat: ${coords[1].toFixed(5)}, Lng: ${coords[0].toFixed(5)}`;
                });

                map.getView().on('change:rotation', function () {
                    const rotation = map.getView().getRotation();
                    compass.style.transform = `rotate(${rotation}rad)`;
                });

                compass.addEventListener('click', () => {
                    map.getView().animate({ rotation: 0, duration: 250 });
                });

                // --- LOGIKA SKALA & RENDERING LAYER ---
                // Skala 1:100.000 (Res ~28-35)
                // Skala 1:50.000  (Res ~14)
                // Skala 1:25.000  (Res ~7)

                function updateLayersByResolution() {
                    const resolution = map.getView().getResolution();

                    // LEVEL 1: Tampilan Awal & Batas Wilayah (1:100.000)
                    if (resolution > 14) {
                        lyr_purwokertoutara_3.setVisible(true); // Label Purwokerto Utara aktif
                        lyr_BatasWilayahDesa_4.setVisible(true);

                        lyr_purwanegara_5.setVisible(false);
                        lyr_Desa_6.setVisible(false);
                        lyr_PointKantorKec_7.setVisible(false);
                        lyr_Kuburan_8.setVisible(false);
                        lyr_BalaiDesa_9.setVisible(false);
                        lyr_sekolah_10.setVisible(false);
                    }
                    // LEVEL 2: Detail Desa & Purwanegara (1:50.000)
                    else if (resolution <= 14 && resolution > 7) {
                        lyr_purwokertoutara_3.setVisible(true);
                        lyr_BatasWilayahDesa_4.setVisible(true);
                        lyr_purwanegara_5.setVisible(true); // Label muncul
                        lyr_Desa_6.setVisible(true);        // Label muncul

                        lyr_PointKantorKec_7.setVisible(false);
                        lyr_Kuburan_8.setVisible(false);
                        lyr_BalaiDesa_9.setVisible(false);
                        lyr_sekolah_10.setVisible(false);
                    }
                    // LEVEL 3: Detail Point POI (1:25.000)
                    else {
                        lyr_purwokertoutara_3.setVisible(true);
                        lyr_purwanegara_5.setVisible(true);
                        lyr_Desa_6.setVisible(true);

                        // Semua point dan labelnya muncul
                        lyr_PointKantorKec_7.setVisible(true);
                        lyr_Kuburan_8.setVisible(true);
                        lyr_BalaiDesa_9.setVisible(true);
                        lyr_sekolah_10.setVisible(true);
                    }
                }

                // Jalankan fungsi setiap kali pengguna melakukan Zoom
                map.getView().on('change:resolution', updateLayersByResolution);

                // --- LOGIKA TOMBOL HOME ---
                btnHome.addEventListener('click', () => {
                    // 1. Animasi kembali ke posisi awal
                    map.getView().animate({
                        center: centerPwtUtara,
                        zoom: initialZoom,
                        duration: 1000
                    });

                    // 2. Berikan sedikit delay agar transisi layer halus setelah animasi selesai
                    setTimeout(() => {
                        updateLayersByResolution();
                    }, 1100);
                });

                // Jalankan fungsi satu kali saat website pertama kali dibuka
                updateLayersByResolution();
            }

            // --- 4. Search & Popup Logic ---
            const searchInput = document.getElementById('sidebar-search');
            const searchResults = document.getElementById('sidebar-search-results');

            // Define layers to search
            const searchLayers = [];
            if (typeof lyr_PointKantorKec_7 !== 'undefined') searchLayers.push(lyr_PointKantorKec_7);
            if (typeof lyr_Kuburan_8 !== 'undefined') searchLayers.push(lyr_Kuburan_8);
            if (typeof lyr_BalaiDesa_9 !== 'undefined') searchLayers.push(lyr_BalaiDesa_9);
            if (typeof lyr_sekolah_10 !== 'undefined') searchLayers.push(lyr_sekolah_10);

            // Override default popup logic from qgis2web.js
            map.on('singleclick', function (evt) {
                // Wait a bit for qgis2web to do its thing, then override or enhance
                setTimeout(() => {
                    const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) { return feature; });

                    if (feature) {
                        const props = feature.getProperties();
                        const name = props['nama'] || props['Nama'] || props['NAME'] || 'Detail Lokasi';

                        const popupTitle = document.getElementById('popup-title');
                        const popupContent = document.getElementById('popup-content');

                        popupTitle.innerText = name;

                        let html = '';
                        // Prioritize 'nama' field
                        if (props['nama'] || props['Nama']) {
                            html += `<div class="info-row">
                                <span class="info-label text-blue-600">Nama Lokasi</span>
                                <span class="info-value text-lg font-bold">${props['nama'] || props['Nama']}</span>
                            </div>`;
                        }

                        for (let key in props) {
                            if (key !== 'geometry' && key !== 'nama' && key !== 'Nama' && typeof props[key] === 'string') {
                                html += `<div class="info-row">
                                    <span class="info-label">${key}</span>
                                    <span class="info-value">${props[key]}</span>
                                </div>`;
                            }
                        }

                        popupContent.innerHTML = html;

                        // Ensure visibility
                        const overlay = map.getOverlayById('popup') || map.getOverlays().getArray().find(o => o.getElement().id === 'popup');
                        if (overlay) {
                            overlay.setPosition(evt.coordinate);
                            document.getElementById('popup').classList.add('visible');
                        }
                    }
                }, 100); // Small delay to override qgis2web
            });

            // Search Logic
            searchInput.addEventListener('input', function (e) {
                const value = e.target.value.toLowerCase();
                searchResults.innerHTML = '';
                searchResults.classList.add('hidden');

                if (value.length < 2) return;

                let allFeatures = [];
                searchLayers.forEach(layer => {
                    const source = layer.getSource();
                    if (source) {
                        allFeatures = allFeatures.concat(source.getFeatures());
                    }
                });

                const filtered = allFeatures.filter(feature => {
                    const props = feature.getProperties();
                    const name = props['nama'] || props['Nama'] || props['NAME'] || '';
                    return name.toLowerCase().includes(value);
                });

                if (filtered.length > 0) {
                    searchResults.classList.remove('hidden');
                    filtered.slice(0, 10).forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 text-sm text-gray-700 flex items-center gap-3 transition-colors';
                        const props = feature.getProperties();
                        const name = props['nama'] || props['Nama'] || props['NAME'] || 'Lokasi Tanpa Nama';
                        div.innerHTML = `
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <span class="font-medium">${name}</span>
                        `;

                        div.addEventListener('click', () => {
                            const geometry = feature.getGeometry();
                            const coord = geometry.getType() === 'Point' ? geometry.getCoordinates() : ol.extent.getCenter(geometry.getExtent());
                            map.getView().animate({ center: coord, zoom: 19, duration: 1000 });

                            // Trigger click to show popup
                            map.dispatchEvent({
                                type: 'singleclick',
                                coordinate: coord,
                                pixel: map.getPixelFromCoordinate(coord)
                            });

                            searchResults.classList.add('hidden');
                            searchInput.value = name;
                        });

                        searchResults.appendChild(div);
                    });
                }
            });

            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });

            // Popup Closer
            document.getElementById('popup-closer').onclick = function () {
                document.getElementById('popup').classList.remove('visible');
                return false;
            };

            // --- 5. Village Filter Logic ---
            const villageSelect = document.getElementById('village-select');
            let originalDesaStyle = null;

            // Capture original style if layer exists
            if (typeof lyr_Desa_6 !== 'undefined') {
                lyr_Desa_6.setOpacity(0.6);
                originalDesaStyle = lyr_Desa_6.getStyle();
            }

            // Ensure Point Kantor Kec and Balai Desa are visible and on top
            if (typeof lyr_PointKantorKec_7 !== 'undefined') {
                lyr_PointKantorKec_7.setVisible(true);
                lyr_PointKantorKec_7.setZIndex(20);
            }
            if (typeof lyr_BalaiDesa_9 !== 'undefined') {
                lyr_BalaiDesa_9.setVisible(true);
                lyr_BalaiDesa_9.setZIndex(20);

                // Override style Balai Desa dengan ikon khusus
                lyr_BalaiDesa_9.setStyle(function (feature) {
                    return new ol.style.Style({
                        image: new ol.style.Icon({
                            anchor: [0.5, 1],
                            // Ganti URL ini dengan path gambar lokal Anda (misal: 'resources/icon-balai.png')
                            src: 'https://cdn-icons-png.flaticon.com/128/167/167707.png',
                            scale: 0.25
                        }),
                        text: new ol.style.Text({
                            text: feature.get('nama') || feature.get('Nama') || '',
                            font: 'bold 11px "Poppins", sans-serif',
                            fill: new ol.style.Fill({ color: '#000000' }),
                            stroke: new ol.style.Stroke({ color: '#ffffff', width: 3 }),
                            offsetY: -35
                        })
                    });
                });
            }

            if (villageSelect && typeof lyr_Desa_6 !== 'undefined') {
                villageSelect.addEventListener('change', function (e) {
                    const selectedName = e.target.value;

                    // 1. Update Layer Style (Filter Visibility)
                    lyr_Desa_6.setStyle(function (feature, resolution) {
                        if (!selectedName) {
                            return originalDesaStyle(feature, resolution);
                        }
                        if (feature.get('NAME_4') === selectedName) {
                            return originalDesaStyle(feature, resolution);
                        }
                        return null; // Hide other features
                    });

                    if (!selectedName) {
                        // Reset to home extent
                        if (typeof map !== 'undefined') {
                            map.getView().fit([12157635.594051, -828329.767149, 12164080.831276, -824960.981116], map.getSize());
                        }
                        return;
                    }

                    // 2. Zoom to Selected Feature
                    const source = lyr_Desa_6.getSource();
                    const features = source.getFeatures();
                    let featureFound = false;

                    for (let i = 0; i < features.length; i++) {
                        const feature = features[i];
                        if (feature.get('NAME_4') === selectedName) {
                            const geometry = feature.getGeometry();
                            if (geometry) {
                                map.getView().fit(geometry.getExtent(), { padding: [50, 50, 50, 50], duration: 1000 });
                                featureFound = true;
                                break;
                            }
                        }
                    }

                    if (!featureFound) {
                        alert("Lokasi desa tidak ditemukan di peta.");
                    }
                });
            }
        });
    </script>
</body>

</html>