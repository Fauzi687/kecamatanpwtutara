<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Peta Desa Grendeng</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <link rel="stylesheet" href="../../../styles.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        display: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        primary: '#10b981',
                        'primary-dark': '#059669',
                        dark: '#0f172a',
                        'dark-light': '#1e293b',
                        accent: '#f59e0b',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; overflow: hidden; }
        
        /* Custom Scrollbar for Sidebar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #1e3a8a; }
        .toggle-checkbox:checked + .toggle-label { background-color: #1e3a8a; }
        
        /* Custom Radio Button */
        .custom-radio:checked + div { border-color: #1e3a8a; }
        .custom-radio:checked + div .radio-dot { transform: scale(1); }

        /* Hide default OL controls */
        .ol-control { display: none !important; }
        .ol-attribution { display: none !important; }
        
        /* Modern Popup Styling */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 0;
            min-width: 300px;
            max-width: 340px;
            bottom: 20px;
            left: -50px;
            transform: translate(-50%, -100%);
            z-index: 100;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            backdrop-filter: blur(10px);
        }
        .ol-popup.visible {
            opacity: 1;
            transform: translate(-50%, -105%);
            pointer-events: auto;
        }
        /* Remove default arrow */
        .ol-popup:after, .ol-popup:before { display: none; }

        .popup-header-modern {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 16px 20px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .popup-content-modern {
            padding: 20px;
            max-height: 320px;
            overflow-y: auto;
            background: white;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .info-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 8px;
        }
        .info-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .info-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .info-value {
            font-size: 0.95rem;
            color: #0f172a;
            font-weight: 500;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen relative overflow-hidden">

    <!-- Map Container -->
    <div id="map" class="absolute inset-0 z-0"></div>

    <!-- Header -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 scrolled">
        <div class="container mx-auto px-4 lg:px-8">
            <nav class="flex items-center justify-between h-20">
                <a href="../../../index.html" class="flex items-center gap-3 group">
                    <div
                        class="w-12 h-12 rounded-xl bg-white/10 backdrop-blur-sm flex items-center justify-center overflow-hidden border-2 border-white/20 group-hover:border-primary transition-all duration-300">
                        <img src="../../../img/kab-banyumas.png" alt="Logo" class="w-10 h-10 object-contain">
                    </div>
                    <div class="text-white">
                        <h1 class="font-bold text-lg leading-tight">Kabupaten</h1>
                        <p class="font-semibold text-sm opacity-90">Banyumas</p>
                    </div>
                </a>

                <div class="hidden lg:flex items-center gap-1">
                    <a href="../../../index.html" class="nav-link"><span class="nav-link-text">Beranda</span><span
                            class="nav-link-hover"></span></a>
                    <a href="../../Kecamatan/pwtutara.html" class="nav-link"><span class="nav-link-text">Peta
                            Kecamatan</span><span class="nav-link-hover"></span></a>
                    <!-- Dropdown Peta Desa -->
                    <div class="relative group">
                        <button class="nav-link flex items-center gap-1">
                            <span class="nav-link-text">Peta Desa</span>
                            <svg class="w-4 h-4 transition-transform duration-200 group-hover:rotate-180" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                                </path>
                            </svg>
                            <span class="nav-link-hover"></span>
                        </button>
                        <div
                            class="absolute top-full left-0 w-56 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                            <div class="bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden">
                                <a href="../sumampir/sumampir.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors border-b border-slate-50">Desa
                                    Sumampir</a>
                                <a href="../pabuaran/pabuaran.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors border-b border-slate-50">Desa
                                    Pabuaran</a>
                                <a href="grendeng.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors border-b border-slate-50">Desa
                                    Grendeng</a>
                                <a href="../bancarkembar/bancarkembar.html"
                                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-primary/5 hover:text-primary transition-colors">Desa
                                    BancarKembar</a>
                            </div>
                        </div>
                    </div>
                    <a href="../../../statistik.html" class="nav-link"><span class="nav-link-text">Data
                            Penduduk</span><span class="nav-link-hover"></span></a>
                    <a href="../../../tentang.html" class="nav-link"><span class="nav-link-text">Tentang
                            Saya</span><span class="nav-link-hover"></span></a>
                </div>

                <button id="menuBtn"
                    class="lg:hidden relative w-12 h-12 flex items-center justify-center rounded-xl bg-white/10 backdrop-blur-sm border border-white/20">
                    <div class="hamburger"><span></span><span></span><span></span></div>
                </button>
            </nav>
        </div>

        <div id="mobileMenu" class="mobile-menu lg:hidden">
            <div class="container mx-auto px-4 py-6 space-y-2">
                <a href="../../../index.html" class="mobile-link"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>Beranda</a>
                <a href="../../Kecamatan/pwtutara.html" class="mobile-link"><svg class="w-5 h-5" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>Peta Kecamatan</a>
                <div class="relative">
                    <button onclick="document.getElementById('mobile-submenu-desa').classList.toggle('hidden')"
                        class="w-full mobile-link flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            </svg>
                            Peta Desa
                        </div>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <div id="mobile-submenu-desa" class="hidden pl-12 pr-4 space-y-2 pb-2">
                        <a href="../sumampir/sumampir.html"
                            class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            Sumampir</a>
                        <a href="../pabuaran/pabuaran.html"
                            class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            Pabuaran</a>
                        <a href="grendeng.html"
                            class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            Grendeng</a>
                        <a href="../bancarkembar/bancarkembar.html" class="block py-2 text-sm text-slate-400 hover:text-primary">Desa
                            BancarKembar</a>
                    </div>
                </div>
                <a href="../../../statistik.html" class="mobile-link"><svg class="w-5 h-5" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>Data Penduduk</a>
                <a href="../../../tentang.html" class="mobile-link"><svg class="w-5 h-5" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>Tentang Saya</a>
            </div>
        </div>
    </header>

    <!-- Floating Title Label -->
    <div class="absolute top-24 left-1/2 transform -translate-x-1/2 z-30 pointer-events-none">
        <div class="bg-white/80 backdrop-blur-md border border-white/50 shadow-xl shadow-blue-900/5 rounded-2xl px-6 py-2 flex items-center gap-3">
            <div class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-600"></span>
            </div>
            <h2 class="text-slate-800 font-bold text-xs tracking-widest uppercase">
                Peta Desa Grendeng
            </h2>
        </div>
    </div>

    <!-- Sidebar (Floating Panel) -->
    <div id="sidebar" class="absolute top-24 left-6 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl shadow-slate-900/20 z-40 flex flex-col max-h-[calc(100vh-140px)] transition-all duration-500 transform translate-x-0 border border-white/50">
        <!-- Sidebar Header -->
        <div class="p-5 border-b border-gray-100 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-3 text-[#0f172a]">
                <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                    <i class="fas fa-layer-group"></i>
                </div>
                <span class="font-bold text-lg">Data & Layer</span>
            </div>
            <button id="close-sidebar" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Search Bar -->
        <div class="px-5 py-4 shrink-0 bg-gray-50/50">
            <div class="relative group">
                <i class="fas fa-search absolute left-3.5 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-blue-600 transition-colors"></i>
                <input type="text" id="sidebar-search" placeholder="Cari Sekolah, Kuburan, Balai Desa..." 
                    class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm">
            </div>
            <div id="sidebar-search-results" class="hidden mt-2 bg-white border border-gray-100 rounded-xl shadow-xl max-h-60 overflow-y-auto custom-scrollbar absolute w-[calc(100%-40px)] left-5 z-50"></div>
        </div>

        <!-- Layer Groups (Scrollable) -->
        <div class="p-5 overflow-y-auto custom-scrollbar flex-1 space-y-8">
            
            <!-- Base Maps -->
            <div class="bg-white rounded-xl">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fas fa-map text-blue-400"></i> Peta Dasar
                </h3>
                <div class="space-y-3" id="basemap-list">
                    <!-- Radio buttons injected here -->
                </div>
            </div>

            <!-- Map Layers -->
            <div class="bg-white rounded-xl">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fas fa-clone text-blue-400"></i> Layer Peta
                </h3>
                <div class="space-y-1" id="layer-list">
                    <!-- Toggles injected here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Toggle Sidebar Button -->
    <button id="open-sidebar" class="absolute top-24 left-6 w-12 h-12 bg-[#0f172a] text-white rounded-xl shadow-xl shadow-blue-900/20 z-30 flex items-center justify-center hover:bg-blue-900 hover:scale-105 transition-all hidden group">
        <i class="fas fa-layer-group text-lg group-hover:rotate-180 transition-transform duration-500"></i>
    </button>

    <!-- Top Right Controls -->
    <div class="absolute top-24 right-6 flex flex-col gap-3 z-30">
        <div class="bg-white/90 backdrop-blur rounded-xl shadow-lg shadow-slate-200/50 p-1.5 flex flex-col gap-1">
            <button id="btn-zoom-in" class="w-9 h-9 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <div class="h-px w-full bg-gray-100"></div>
            <button id="btn-zoom-out" class="w-9 h-9 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        
        <button id="btn-home" class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-lg shadow-slate-200/50 text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all" title="Home">
            <i class="fas fa-home text-lg"></i>
        </button>
        
        <button id="btn-location" class="w-12 h-12 bg-white/90 backdrop-blur rounded-xl shadow-lg shadow-slate-200/50 text-gray-600 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all" title="Lokasi Saya">
            <i class="fas fa-crosshairs text-lg"></i>
        </button>
    </div>

    <!-- Bottom Right Info -->
    <div class="absolute bottom-8 right-6 flex flex-col items-end gap-4 z-30 pointer-events-none">
        <!-- Compass -->
        <div class="w-14 h-14 bg-white/90 backdrop-blur rounded-full shadow-xl shadow-slate-200/50 flex items-center justify-center pointer-events-auto transform transition-transform duration-500 cursor-pointer hover:scale-105 border-2 border-white" id="compass" title="Reset Utara">
            <i class="far fa-compass text-4xl text-blue-600"></i>
        </div>
        
        <!-- Coordinates -->
        <div class="bg-[#0f172a]/80 backdrop-blur-md px-4 py-2 rounded-full shadow-lg text-xs font-mono text-white pointer-events-auto border border-white/10 flex items-center gap-2">
            <i class="fas fa-map-marker-alt text-blue-400"></i>
            <span id="mouse-coordinates">Lat: -, Lng: -</span>
        </div>
    </div>

    <!-- Modern Popup -->
    <div id="popup" class="ol-popup">
        <div class="popup-header-modern">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-info text-white text-sm"></i>
                </div>
                <span id="popup-title" class="font-bold text-lg tracking-wide">Detail Info</span>
            </div>
            <a href="#" id="popup-closer" class="text-white/70 hover:text-white transition-colors">
                <i class="fas fa-times text-lg"></i>
            </a>
        </div>
        <div id="popup-content" class="popup-content-modern custom-scrollbar">
            <!-- Content injected via JS -->
        </div>
    </div>

    <script src="resources/qgis2web_expressions.js"></script>
    <script src="./resources/functions.js"></script>
    <script src="./resources/ol.js"></script>
    <script src="resources/horsey.min.js"></script>
    <script src="resources/ol-search-layer.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="resources/photon-geocoder-autocomplete.min.js"></script>
    
    <!-- Load Layers -->
    <script src="layers/Grendeng_3.js"></script>
    <script src="layers/Kuburan_4.js"></script>
    <script src="layers/Kesehatan_5.js"></script>
    <script src="layers/Sekolah_6.js"></script>
    <script src="layers/BalaiDesa_7.js"></script>
    
    <!-- Load Styles -->
    <script src="styles/Grendeng_3_style.js"></script>
    <script src="styles/Kuburan_4_style.js"></script>
    <script src="styles/Kesehatan_5_style.js"></script>
    <script src="styles/Sekolah_6_style.js"></script>
    <script src="styles/BalaiDesa_7_style.js"></script>
    
    <script src="./layers/layers.js" type="text/javascript"></script>
    <script src="./resources/Autolinker.min.js"></script>
    <script src="./resources/qgis2web.js"></script>
    <script src="../../../script.js"></script>

    <!-- Custom UI Logic -->
    <script>
       document.addEventListener('DOMContentLoaded', function() {
    // --- 1. Sidebar Logic ---
    const sidebar = document.getElementById('sidebar');
    const closeSidebarBtn = document.getElementById('close-sidebar');
    const openSidebarBtn = document.getElementById('open-sidebar');

    function toggleSidebar(show) {
        if (show) {
            sidebar.classList.remove('-translate-x-full', 'opacity-0');
            sidebar.classList.add('translate-x-0', 'opacity-100');
            openSidebarBtn.classList.add('hidden');
        } else {
            sidebar.classList.add('-translate-x-full', 'opacity-0');
            sidebar.classList.remove('translate-x-0', 'opacity-100');
            setTimeout(() => openSidebarBtn.classList.remove('hidden'), 500);
        }
    }

    closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
    openSidebarBtn.addEventListener('click', () => toggleSidebar(true));

    // --- 2. Layer Management ---
    const basemapList = document.getElementById('basemap-list');
    const layerList = document.getElementById('layer-list');

    function createBasemapRadio(layer, index, isChecked) {
        const id = `basemap-${index}`;
        const div = document.createElement('div');
        div.className = 'relative flex items-center cursor-pointer group p-2 rounded-lg hover:bg-gray-50 transition-colors';
        div.innerHTML = `
            <input type="radio" name="basemap" id="${id}" class="peer sr-only" ${isChecked ? 'checked' : ''}>
            <div class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center peer-checked:border-blue-600 transition-colors">
                <div class="w-2.5 h-2.5 bg-blue-600 rounded-full transform scale-0 peer-checked:scale-100 transition-transform radio-dot"></div>
            </div>
            <label for="${id}" class="text-sm text-gray-600 group-hover:text-blue-800 cursor-pointer select-none font-medium">${layer.get('title')}</label>
        `;
        div.addEventListener('click', (e) => {
            if(e.target.tagName !== 'INPUT') document.getElementById(id).click();
        });
        div.querySelector('input').addEventListener('change', () => {
            layersList.forEach(l => { if (l.get('type') === 'base') l.setVisible(false); });
            layer.setVisible(true);
        });
        return div;
    }

    function createLayerToggle(layer, index) {
        const id = `layer-${index}`;
        const title = layer.get('title') ? layer.get('title').replace(/<img.*?>/g, '').trim() : 'Unnamed Layer';
        const isVisible = layer.getVisible();
        
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between py-2 px-2 rounded-lg hover:bg-gray-50 transition-colors';
        div.innerHTML = `
            <span class="text-sm text-gray-700 font-medium">${title}</span>
            <div class="relative inline-block w-11 h-6 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="toggle" id="${id}" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-0.5 ${isVisible ? 'right-0.5 border-blue-600' : 'left-0.5 border-gray-300'}" ${isVisible ? 'checked' : ''}/>
                <label for="${id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-200 cursor-pointer transition-colors duration-300 ${isVisible ? 'bg-blue-600' : ''}"></label>
            </div>
        `;
        
        const checkbox = div.querySelector('input');
        const label = div.querySelector('label');
        
        checkbox.addEventListener('change', function() {
            layer.setVisible(this.checked);
            if(this.checked) {
                this.classList.add('right-0.5', 'border-blue-600');
                this.classList.remove('left-0.5', 'border-gray-300');
                label.classList.add('bg-blue-600');
                label.classList.remove('bg-gray-200');
            } else {
                this.classList.add('left-0.5', 'border-gray-300');
                this.classList.remove('right-0.5', 'border-blue-600');
                label.classList.add('bg-gray-200');
                label.classList.remove('bg-blue-600');
            }
        });
        return div;
    }

    if (typeof layersList !== 'undefined') {
        layersList.forEach((layer, index) => {
            if (layer.get('type') === 'base') {
                const isChecked = layer.getVisible(); 
                basemapList.appendChild(createBasemapRadio(layer, index, isChecked));
            } else if (layer instanceof ol.layer.Group) {
                const groupTitle = layer.get('title');
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-4';
                groupDiv.innerHTML = `<h4 class="text-xs font-bold text-blue-600 uppercase mb-2 ml-2 tracking-wider">${groupTitle}</h4>`;
                layer.getLayers().forEach((subLayer, subIndex) => {
                    groupDiv.appendChild(createLayerToggle(subLayer, `${index}-${subIndex}`));
                });
                layerList.appendChild(groupDiv);
            } else {
                layerList.appendChild(createLayerToggle(layer, index));
            }
        });
    }

    // --- 3. Map Controls & Home Logic ---
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const btnHome = document.getElementById('btn-home');
    const btnLocation = document.getElementById('btn-location');
    const compass = document.getElementById('compass');
    const coordDisplay = document.getElementById('mouse-coordinates');

    // Koordinat Awal Desa Grendeng (Disamakan dengan gaya Pabuaran)
    const centerGrendeng = ol.proj.fromLonLat([109.2495, -7.4060]);
    const initialZoom = 13.5; // Scale approx 1:50.000

    if (typeof map !== 'undefined') {
        // Atur tampilan awal saat web dibuka
        map.getView().setCenter(centerGrendeng);
        map.getView().setZoom(initialZoom);

        // Atur opacity layer desa agar tembus pandang (tidak tebal)
        if (typeof lyr_Grendeng_3 !== 'undefined') {
            lyr_Grendeng_3.setOpacity(0.4);
        }

        // Add Label "Grendeng"
        const labelFeature = new ol.Feature({
            geometry: new ol.geom.Point(centerGrendeng),
            name: 'Desa Grendeng'
        });
        const labelStyle = new ol.style.Style({
            text: new ol.style.Text({
                text: 'Desa Grendeng',
                font: 'bold 16px "Plus Jakarta Sans", sans-serif',
                fill: new ol.style.Fill({ color: '#1e3a8a' }),
                stroke: new ol.style.Stroke({ color: '#ffffff', width: 3 }),
                offsetY: 0
            })
        });
        labelFeature.setStyle(labelStyle);
        const labelLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: [labelFeature]
            }),
            zIndex: 999,
            title: 'Label Desa'
        });
        map.addLayer(labelLayer);

        btnZoomIn.addEventListener('click', () => {
            const view = map.getView();
            view.animate({zoom: view.getZoom() + 1, duration: 250});
        });

        btnZoomOut.addEventListener('click', () => {
            const view = map.getView();
            view.animate({zoom: view.getZoom() - 1, duration: 250});
        });

        // Tombol Home kembali ke koordinat awal desa
        btnHome.addEventListener('click', () => {
            map.getView().animate({
                center: centerGrendeng,
                zoom: initialZoom,
                duration: 1000
            });
        });

        btnLocation.addEventListener('click', () => {
            if (typeof geolocation !== 'undefined') {
                 if (!geolocation.getTracking()) geolocation.setTracking(true);
                 const pos = geolocation.getPosition();
                 if (pos) {
                     map.getView().animate({center: pos, zoom: 17, duration: 1000});
                 } else {
                     alert("Lokasi belum ditemukan. Pastikan GPS aktif.");
                 }
            }
        });

        map.on('pointermove', function(evt) {
            const coords = ol.proj.toLonLat(evt.coordinate);
            coordDisplay.innerText = `Lat: ${coords[1].toFixed(5)}, Lng: ${coords[0].toFixed(5)}`;
        });

        map.getView().on('change:rotation', function() {
            const rotation = map.getView().getRotation();
            compass.style.transform = `rotate(${rotation}rad)`;
        });
        
        compass.addEventListener('click', () => {
            map.getView().animate({rotation: 0, duration: 250});
        });
    }

    // --- 4. Search & Popup Logic ---
    const searchInput = document.getElementById('sidebar-search');
    const searchResults = document.getElementById('sidebar-search-results');
    
    const searchLayers = [];
    if (typeof lyr_Kuburan_4 !== 'undefined') searchLayers.push(lyr_Kuburan_4);
    if (typeof lyr_Kesehatan_5 !== 'undefined') searchLayers.push(lyr_Kesehatan_5);
    if (typeof lyr_Sekolah_6 !== 'undefined') searchLayers.push(lyr_Sekolah_6);
    if (typeof lyr_BalaiDesa_7 !== 'undefined') searchLayers.push(lyr_BalaiDesa_7);

    map.on('singleclick', function(evt) {
        setTimeout(() => {
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) { return feature; });
            if (feature) {
                const props = feature.getProperties();
                const name = props['nama'] || props['Nama'] || props['NAME'] || 'Detail Lokasi';
                const popupTitle = document.getElementById('popup-title');
                const popupContent = document.getElementById('popup-content');
                popupTitle.innerText = name;
                let html = '';
                if (props['nama'] || props['Nama']) {
                    html += `<div class="info-row"><span class="info-label text-blue-600">Nama Lokasi</span><span class="info-value text-lg font-bold">${props['nama'] || props['Nama']}</span></div>`;
                }
                for (let key in props) {
                    if (key !== 'geometry' && key !== 'nama' && key !== 'Nama' && typeof props[key] === 'string') {
                        html += `<div class="info-row"><span class="info-label">${key}</span><span class="info-value">${props[key]}</span></div>`;
                    }
                }
                popupContent.innerHTML = html;
                const overlay = map.getOverlayById('popup') || map.getOverlays().getArray().find(o => o.getElement().id === 'popup');
                if(overlay) {
                    overlay.setPosition(evt.coordinate);
                    document.getElementById('popup').classList.add('visible');
                }
            }
        }, 100);
    });

    searchInput.addEventListener('input', function(e) {
        const value = e.target.value.toLowerCase();
        searchResults.innerHTML = '';
        searchResults.classList.add('hidden');
        if (value.length < 2) return;
        let allResults = [];
        searchLayers.forEach(layer => {
            if (layer.getSource()) {
                const features = layer.getSource().getFeatures();
                const filtered = features.filter(feature => {
                    const props = feature.getProperties();
                    const name = (props['nama'] || props['Nama'] || props['NAME'] || '').toLowerCase();
                    return name.includes(value);
                });
                filtered.forEach(feature => {
                    allResults.push({
                        feature: feature,
                        name: feature.get('nama') || feature.get('Nama') || 'Unnamed'
                    });
                });
            }
        });
        if (allResults.length > 0) {
            searchResults.classList.remove('hidden');
            allResults.slice(0, 10).forEach(result => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 text-sm flex items-center gap-3';
                div.innerHTML = `<i class="fas fa-map-pin text-blue-600"></i><span>${result.name}</span>`;
                div.addEventListener('click', () => {
                    const coords = result.feature.getGeometry().getCoordinates();
                    map.getView().animate({center: coords, zoom: 17, duration: 500});
                    searchResults.classList.add('hidden');
                    searchInput.value = '';
                });
                searchResults.appendChild(div);
            });
        }
    });

    document.getElementById('popup-closer').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('popup').classList.remove('visible');
    });
});
    </script>
</body>
</html>
